// extensibility v0.0.1
// Copyright (c)2015 Boris Kozorovitzky.
// Distributed under MIT license
// https://github.com/BorisKozo/extensibility.js.git

!function(a,b){if("function"==typeof define&&define.amd)define(["lodash","exports"],function(c,d){a.EJS=b(a,d,c)});else if("undefined"!=typeof exports){var c=require("underscore");b(a,exports,c)}else a.EJS=b(a,{},a._)}(this,function(a,b,c){!function(a){"use strict";var b=[],d=b.slice,e={on:function(a,b,c){if(!g(this,"on",a,[b,c])||!b)return this;this._events=this._events?this._events:{};var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,d){if(!g(this,"once",a,[b,d])||!b)return this;var e=this,f=c.once(function(){e.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,d)},off:function(a,b,d){var e,f,h,i,j,k,l,m;if(!this._events||!g(this,"off",a,[b,d]))return this;if(!a&&!b&&!d)return this._events=void 0,this;for(i=a?[a]:c.keys(this._events),j=0,k=i.length;k>j;j++)if(a=i[j],h=this._events[a]){if(this._events[a]=e=[],b||d)for(l=0,m=h.length;m>l;l++)f=h[l],(b&&b!==f.callback&&b!==f.callback._callback||d&&d!==f.context)&&e.push(f);e.length||delete this._events[a]}return this},offContext:function(a){this.off(null,null,a)},trigger:function(a){if(!this._events)return this;var b=d.call(arguments,1);if(!g(this,"trigger",a,b))return this;var c=this._events[a],e=this._events.all;return c&&h(c,b),e&&h(e,arguments),this},stopListening:function(a,b,d){var e=this._listeningTo;if(!e)return this;var f=!b&&!d;d||"object"!=typeof b||(d=this),a&&((e={})[a._listenId]=a);for(var g in e)a=e[g],a.off(b,d,this),(f||c.isEmpty(a._events))&&delete this._listeningTo[g];return this}},f=/\s+/,g=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(f.test(c)){for(var g=c.split(f),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(d));return!1}return!0},h=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},i={listenTo:"on",listenToOnce:"once"};c.each(i,function(a,b){e[b]=function(b,d,e){var f=this._listeningTo||(this._listeningTo={}),g=b._listenId||(b._listenId=c.uniqueId("l"));return f[g]=b,e||"object"!=typeof d||(e=this),b[a](d,e,this),this}}),a.Events=e,a.createEventBus=function(b){return b=b||{},c.assign(b,a.Events)}}(b),function(a){"use strict";function b(a){this.id=g++,this.mergedIds={},this.addins=[a],this.order=c.isNumber(a.order)?a.order:0,this.dependsOnClusters={},this.activeAddin=a}function d(a){var b,c,d;for(c=1;c<arguments.length;c++)for(d=arguments[c],b=0;b<d.length;b++)if(d[b].containsAddin(a))return d[b];return null}function e(a){var e,f,g,h,i,j=[],k=null,l=null;for(e=c.map(a,function(a){return new b(a)});e.length>0;)if(f=e.pop(),h=f.activeAddin,c.isString(h.order))for(i=h.order.split(","),g=0;g<i.length;g++)if(0===c.indexOf(i[g],">"))if(1===c.indexOf(i[g],">",1)){if(k=i[g].substring(2),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for >> dependency");if(l.id===f.id&&!l.verifyOrder(k,h.id))throw new Error("Could not find appropriate order for "+k+" and "+h.id);f.dependsOnClusters[l.id]=!0,c.contains(j,f)||j.push(f)}else{if(g!==i.length-1)throw new Error("> dependency must be last in "+h.order+" at "+h.id);if(k=i[g].substring(1),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for > dependency");if(l.id!==f.id){if(l.last().id===k){if(l.dependsOnClusters[f.id])throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.mergeToEnd(f),c.remove(j,f);break}throw new Error("Could not fulfill > dependency for "+k+" because "+l.last().id+" already has the same dependency")}if(!l.verifyOrder(k,h.id,!0))throw new Error("Could not find appropriate order for "+k+" and "+h.id);c.contains(j,f)||j.push(f)}else{if(0!==c.indexOf(i[g],"<"))throw new Error("order must begin with <, <<, >, >> or be a number");if(1===c.indexOf(i[g],"<",1)){if(k=i[g].substring(2),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for << dependency");if(l.id===f.id&&!l.verifyOrder(h.id,k))throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.dependsOnClusters[f.id]=!0,c.contains(j,f)||j.push(f)}else{if(g!==i.length-1)throw new Error("< dependency must be last in "+h.order+" at "+h.id);if(k=i[g].substring(1),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for < dependency");if(l.id!==f.id){if(l.first().id===k){if(f.dependsOnClusters[l.id])throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.mergeToFront(f),c.remove(j,f);break}throw new Error("Could not fulfill < dependency for "+k+" because "+l.first().id+" already has the same dependency")}if(!l.verifyOrder(h.id,k,!0))throw new Error("Could not find appropriate order for "+k+" and "+h.id);c.contains(j,f)||j.push(f)}}else{if(!c.isNumber(h.order))throw new Error("order must begin with <, <<, >, >> or be a number");j.push(f)}return j}function f(a){for(var b,d,e,f,g,h=[],i=[],j=c.clone(a),k=[];j.length>0;){for(g=j.length,k=[],i=[],b=0;b<j.length;b++)0===c.keys(j[b].dependsOnClusters).length?k.push(j[b]):i.push(j[b]);for(b=0;b<k.length;b++)for(f=c.keys(k[b].mergedIds),f.push(String(k[b].id)),e=0;e<f.length;e++)for(d=0;d<i.length;d++)delete i[d].dependsOnClusters[f[e]];for(k=c.sortBy(k,"order"),b=0;b<k.length;b++)for(d=0;d<k[b].addins.length;d++)h.push(k[b].addins[d]);if(j=i,g===j.length)throw new Error("Circular dependency detected in topological sort")}return h}var g=0;b.prototype.containsAddin=function(a){return-1!==c.findIndex(this.addins,{id:a})},b.prototype.verifyOrder=function(a,b,d){if(a===b)return!1;var e=c.findIndex(this.addins,{id:a});if(-1===e)throw new Error("Could not find addin with id "+a+" in cluster "+this.id);var f=c.findIndex(this.addins,{id:b});if(-1===f)throw new Error("Could not find addin with id "+b+" in cluster "+this.id);var g=f-e;return d?1==g:g>0},b.prototype.first=function(){return this.addins[0]},b.prototype.last=function(){return this.addins[this.addins.length-1]},b.prototype.mergeToEnd=function(a){var b;for(b=0;b<a.addins.length;b++)this.addins.push(a.addins[b]);this.mergedIds[a.id]=!0,this.mergedIds=c.assign(this.mergedIds,a.mergedIds),this.dependsOnClusters=c.assign(this.dependsOnClusters,a.dependsOnClusters)},b.prototype.mergeToFront=function(a){var b;for(b=a.addins.length-1;b>=0;b--)this.addins.unshift(a.addins[b]);this.mergedIds[a.id]=!0,this.mergedIds=c.assign(this.mergedIds,a.mergedIds),this.dependsOnClusters=c.assign(this.dependsOnClusters,a.dependsOnClusters)},a.utils||(a.utils={}),a.utils.topologicalSort=function(b){var c=a.utils.topologicalSort._formSortClusters(b);return a.utils.topologicalSort._sortClusters(c)},a.utils.topologicalSort._formSortClusters=e,a.utils.topologicalSort._sortClusters=f}(b),function(a){"use strict";function b(){return c.isFunction(a.buildServices)?(a.vent.trigger("before:buildServices"),a.buildServices().then(function(){a.vent.trigger("after:buildServices")})):Promise.resolve()}a.systemPathPrefix="EJS",a.vent=a.createEventBus(),a.start=function(){return a.defaultManifest&&(a.vent.trigger("before:readDefaultManifest"),a.readManifest(a.defaultManifest),a.vent.trigger("after:readDefaultManifest")),b()}}(b),function(a){"use strict";function b(a){this.name=a,this.nodes={},this.addins=[]}var d,e="/";b.prototype.addAddin=function(a){this.addins.push(a)},a.registry={getNode:function(e,f){c.isString(e)&&(e=a.registry.breakPath(e));var g,h=d;for(g=0;g<e.length;g++){if(!h.nodes[e[g]]){if(!f)return null;h.nodes[e[g]]=new b(e[g])}h=h.nodes[e[g]]}return h},verifyAxis:function(a,b){return c.isString(a)?c.isEmpty(a)||c.indexOf(a,b)>=0?!1:!0:!1},joinPath:function(){if(0===arguments.length)return"";if(arguments[0]instanceof Array)return a.registry.joinPath.apply(this,c.flatten(arguments[0]));var b=Array.prototype.slice.call(arguments,0),d=[];return c.forEach(b,function(b){var c,e=a.registry.breakPath(b);for(c=0;c<e.length;c++)d.push(e[c])}),0===d.length?"":d.join(e)},breakPath:function(b){if(!c.isString(b))throw new Error("path must be a string "+JSON.stringify(b));if(""===b)return[];var d=b.split(e);return c.forEach(d,function(b){if(!a.registry.verifyAxis(b,e))throw new Error("Invalid axis "+b)}),d},nodeExists:function(a){var b=this.getNode(a,!1);return null!==b},clear:function(){d=new b("")}},a.registry.clear()}(b),function(a){"use strict";var b=0;a.Addin=function(a){a=c.isFunction(a)?a():a||{};var d=c.assign({},a);return d.id=d.id?String(d.id):"addin"+b++,d.order=d.order||0,d},a.addAddin=function(b,c){var d=a.registry.getNode(b,!0);c&&d.addAddin(c)},a.getAddins=function(b,d,e){var f=a.registry.getNode(b,!1);if(null===f)return[];var g=e?f.addins:a.utils.topologicalSort(f.addins);return void 0===d?c.clone(g):c.filter(g,d)}}(b),function(a){"use strict";var b=0;a.Builder=function(d){if(d=c.isFunction(d)?d():d||{},!c.isFunction(d.build))throw new Error('Builder options must contain the "build" function '+JSON.stringify(d));d.id=d.id||"builder"+b++,d.order=d.order||0;var e=new a.Addin(d);return e.type=d.hasOwnProperty("type")?d.type:"",e.build=d.build,e.$next=a.Builder.nextBuilder,e},a.Builder.nextBuilder=function(){var b=a.getBuilders(this.type),d=c.indexOf(b,this);return b[d+1]},a.systemBuildersPath=a.registry.joinPath(a.systemPathPrefix,"builders"),a.addBuilder=function(b){var c=new a.Builder(b);a.addAddin(a.systemBuildersPath,c)},a.getBuilders=function(b){var c=a.getAddins(a.systemBuildersPath,{type:b});if(c.length>0)return c;if(c=a.getAddins(a.systemBuildersPath,{type:null}),c.length>0)return c;throw new Error('No builder of type "'+b+'" was defined and no default builder was registered')},a.getBuilder=function(b){return a.getBuilders(b)[0]},a.build=function(b,d,e){var f=a.getAddins(b,d,e);return 0===f.length?f:c.map(f,function(b){var c=a.getBuilder(b.type);return c.build(b)})},a.buildTree=function(b){var d=a.getAddins(b);return 0===d.length?d:c.map(d,function(c){var d=a.getBuilder(c.type),e=d.build(c),f=c.itemsProperty||"$items";return e[f]=a.buildTree(a.registry.joinPath(b,c.id)),e})}}(b),function(a){"use strict";function b(a){return a?b(a.$next).then(function(){return a.hasOwnProperty("initialize")&&c.isFunction(a.initialize)?a.initialize():Promise.resolve()}):Promise.resolve()}var d={};a.Service=function(b,d){var e=Object.create(d||{});return c.isFunction(b)&&(b=b()),b=b||{},e=c.assign(e,{$vent:a.createEventBus(),$next:d?d:void 0},b)},a.Service.builder={type:"EJS.service",id:"EJS.serviceBuilder",order:100,build:function(b){if(!c.isString(b.name)||c.isEmpty(b.name))throw new Error("Service name must be defined "+JSON.stringify(b));a.addService(b.name,b.content,b.override)}},a.systemServicesPath=a.registry.joinPath(a.systemPathPrefix,"services"),a.addBuilder(a.Service.builder),a.getService=function(a){return d[a]},a.addService=function(b,c,e){b=String(b).trim();var f;e||(f=a.getService(b));var g=new a.Service(c,f);return d[b]=g,g},a.clearServices=function(){d={}},a.buildServices=function(){a.build(a.systemServicesPath);var e=[];return c.forEach(c.keys(d),function(c){a.vent.trigger("before:service:initialized",c),e.push(b(a.getService(c)).then(function(){a.vent.trigger("after:service:initialized",c,a.getService(c))}))}),Promise.all(e)}}(b),function(a){"use strict";var b=0;a.Command=function(a){a=c.isFunction(a)?a():a||{};var d=c.assign({},a);return d.id=d.id?String(d.id):"addin"+b++,d.order=d.order||0,d}}(b),function(a){"use strict";a.defaultManifest={paths:[{path:a.systemBuildersPath,addins:[{id:"EJS.defaultBuilder",type:null,order:100,build:function(a){return a.content}}]}]}}(b),function(a){"use strict";a.readManifest=function(b){c.forEach(b.paths,function(b){c.forEach(b.addins,function(c){a.addAddin(b.path,new a.Addin(c))})})}}(b)});