// extensibility v0.0.1
// Copyright (c)2014 Boris Kozorovitzky.
// Distributed under MIT license
// https://github.com/BorisKozo/extensibility.js.git

!function(a,b){if("function"==typeof define&&define.amd)define(["lodash","exports"],function(c,d){a.EJS=b(a,d,c)});else if("undefined"!=typeof exports){var c=require("underscore");b(a,exports,c)}else a.EJS=b(a,{},a._)}(this,function(a,b,c){!function(a){"use strict";var b={on:function(a,b,c){if(!e(this,"on",a,[b,c])||!b)return this;this._events=this._events?this._events:{};var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,d){if(!e(this,"once",a,[b,d])||!b)return this;var f=this,g=c.once(function(){f.off(a,g),b.apply(this,arguments)});return g._callback=b,this.on(a,g,d)},off:function(a,b,d){var f,g,h,i,j,k,l,m;if(!this._events||!e(this,"off",a,[b,d]))return this;if(!a&&!b&&!d)return this._events=void 0,this;for(i=a?[a]:c.keys(this._events),j=0,k=i.length;k>j;j++)if(a=i[j],h=this._events[a]){if(this._events[a]=f=[],b||d)for(l=0,m=h.length;m>l;l++)g=h[l],(b&&b!==g.callback&&b!==g.callback._callback||d&&d!==g.context)&&f.push(g);f.length||delete this._events[a]}return this},offAll:function(a){this.off(null,null,a)},trigger:function(a){if(!this._events)return this;var b=slice.call(arguments,1);if(!e(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&f(c,b),d&&f(d,arguments),this},stopListening:function(a,b,d){var e=this._listeningTo;if(!e)return this;var f=!b&&!d;d||"object"!=typeof b||(d=this),a&&((e={})[a._listenId]=a);for(var g in e)a=e[g],a.off(b,d,this),(f||c.isEmpty(a._events))&&delete this._listeningTo[g];return this}},d=/\s+/,e=function(a,b,c,e){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(e));return!1}if(d.test(c)){for(var g=c.split(d),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(e));return!1}return!0},f=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b);return}},g={listenTo:"on",listenToOnce:"once"};c.each(g,function(a,d){b[d]=function(b,d,e){var f=this._listeningTo||(this._listeningTo={}),g=b._listenId||(b._listenId=c.uniqueId("l"));return f[g]=b,e||"object"!=typeof d||(e=this),b[a](d,e,this),this}}),a.Events=b}(b),function(a){"use strict";function b(a){this.id=g++,this.mergedIds={},this.addins=[a],this.order=c.isNumber(a.order)?a.order:0,this.dependsOnClusters={},this.activeAddin=a}function d(a){var b,c,d;for(c=1;c<arguments.length;c++)for(d=arguments[c],b=0;b<d.length;b++)if(d[b].containsAddin(a))return d[b];return null}function e(a){var e,f,g,h,i,j=[],k=null,l=null;for(e=c.map(a,function(a){return new b(a)});e.length>0;)if(f=e.pop(),h=f.activeAddin,c.isString(h.order))for(i=h.order.split(","),g=0;g<i.length;g++)if(0===c.indexOf(i[g],">"))if(1===c.indexOf(i[g],">",1)){if(k=i[g].substring(2),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for >> dependency");if(l.id===f.id&&!l.verifyOrder(k,h.id))throw new Error("Could not find appropriate order for "+k+" and "+h.id);f.dependsOnClusters[l.id]=!0,c.contains(j,f)||j.push(f)}else{if(g!==i.length-1)throw new Error("> dependency must be last in "+h.order+" at "+h.id);if(k=i[g].substring(1),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for > dependency");if(l.id!==f.id){if(l.last().id===k){if(l.dependsOnClusters[f.id])throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.mergeToEnd(f),c.remove(j,f);break}throw new Error("Could not fulfill > dependency for "+k+" because "+l.last().id+" already has the same dependency")}if(!l.verifyOrder(k,h.id,!0))throw new Error("Could not find appropriate order for "+k+" and "+h.id);c.contains(j,f)||j.push(f)}else{if(0!==c.indexOf(i[g],"<"))throw new Error("order must begin with <, <<, >, >> or be a number");if(1===c.indexOf(i[g],"<",1)){if(k=i[g].substring(2),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for << dependency");if(l.id===f.id&&!l.verifyOrder(h.id,k))throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.dependsOnClusters[f.id]=!0,c.contains(j,f)||j.push(f)}else{if(g!==i.length-1)throw new Error("< dependency must be last in "+h.order+" at "+h.id);if(k=i[g].substring(1),l=d(k,e,j,[f]),null===l)throw new Error("Could not find cluster with id "+k+" for < dependency");if(l.id!==f.id){if(l.first().id===k){if(f.dependsOnClusters[l.id])throw new Error("Could not find appropriate order for "+k+" and "+h.id);l.mergeToFront(f),c.remove(j,f);break}throw new Error("Could not fulfill < dependency for "+k+" because "+l.first().id+" already has the same dependency")}if(!l.verifyOrder(h.id,k,!0))throw new Error("Could not find appropriate order for "+k+" and "+h.id);c.contains(j,f)||j.push(f)}}else{if(!c.isNumber(h.order))throw new Error("order must begin with <, <<, >, >> or be a number");j.push(f)}return j}function f(a){for(var b,d,e,f,g,h=[],i=[],j=c.clone(a),k=[];j.length>0;){for(g=j.length,k=[],i=[],b=0;b<j.length;b++)0===c.keys(j[b].dependsOnClusters).length?k.push(j[b]):i.push(j[b]);for(b=0;b<k.length;b++)for(f=c.keys(k[b].mergedIds),f.push(String(k[b].id)),e=0;e<f.length;e++)for(d=0;d<i.length;d++)delete i[d].dependsOnClusters[f[e]];for(k=c.sortBy(k,"order"),b=0;b<k.length;b++)for(d=0;d<k[b].addins.length;d++)h.push(k[b].addins[d]);if(j=i,g===j.length)throw new Error("Circular dependency detected in topological sort")}return h}var g=0;b.prototype.containsAddin=function(a){return-1!==c.findIndex(this.addins,{id:a})},b.prototype.verifyOrder=function(a,b,d){if(a===b)return!1;var e=c.findIndex(this.addins,{id:a});if(-1===e)throw new Error("Could not find addin with id "+a+" in cluster "+this.id);var f=c.findIndex(this.addins,{id:b});if(-1===f)throw new Error("Could not find addin with id "+b+" in cluster "+this.id);var g=f-e;return d?1==g:g>0},b.prototype.first=function(){return this.addins[0]},b.prototype.last=function(){return this.addins[this.addins.length-1]},b.prototype.mergeToEnd=function(a){var b;for(b=0;b<a.addins.length;b++)this.addins.push(a.addins[b]);this.mergedIds[a.id]=!0,this.mergedIds=c.assign(this.mergedIds,a.mergedIds),this.dependsOnClusters=c.assign(this.dependsOnClusters,a.dependsOnClusters)},b.prototype.mergeToFront=function(a){var b;for(b=a.addins.length-1;b>=0;b--)this.addins.unshift(a.addins[b]);this.mergedIds[a.id]=!0,this.mergedIds=c.assign(this.mergedIds,a.mergedIds),this.dependsOnClusters=c.assign(this.dependsOnClusters,a.dependsOnClusters)},a.utils||(a.utils={}),a.utils.topologicalSort=function(b){var c=a.utils.topologicalSort._formSortClusters(b);return a.utils.topologicalSort._sortClusters(c)},a.utils.topologicalSort._formSortClusters=e,a.utils.topologicalSort._sortClusters=f}(b),function(a){"use strict";function b(a){this.name=a,this.nodes={},this.addins=[]}var d,e="/";b.prototype.addAddin=function(a){this.addins.push(a)},a.registry=c.assign(a.registry||{},{systemPathPrefix:"EJS",_getNode:function(e,f){c.isString(e)&&(e=a.registry.breakPath(e));var g,h=d;for(g=0;g<e.length;g++){if(!h.nodes[e[g]]){if(!f)return null;h.nodes[e[g]]=new b(e[g])}h=h.nodes[e[g]]}return h},verifyAxis:function(a,b){return c.isString(a)?c.isEmpty(a)||c.indexOf(a,b)>=0?!1:!0:!1},joinPath:function(){if(0===arguments.length)return"";if(arguments[0]instanceof Array)return a.registry.joinPath.apply(this,c.flatten(arguments[0]));var b=Array.prototype.slice.call(arguments,0);return b.reduce(function(b,c){if(a.registry.verifyAxis(c,e))return""===b?c:b+e+c;throw new Error("Illegal path axis "+c+" for delimiter "+e)},"")},breakPath:function(b){if(!c.isString(b))throw new Error("path must be a string "+JSON.stringify(b));if(""===b)return[];var d=b.split(e);return c.forEach(d,function(b){if(!a.registry.verifyAxis(b,e))throw new Error("Invalid axis "+b)}),d},nodeExists:function(a){var b=this._getNode(a,!1);return null!==b},clear:function(){d=new b("")}}),a.registry.clear()}(b),function(a){"use strict";var b=0;a.Addin=function(a){a=c.isFunction(a)?a():a||{},this.id=a.id||"addin"+b++,this.order=a.order||0},a.registry=c.assign(a.registry||{},{addAddin:function(a,b){var c=this._getNode(a,!0);b&&c.addAddin(b)},getAddins:function(b,d,e){var f=this._getNode(b,!1);if(null===f)return null;var g=e?f.addins:a.utils.topologicalSort(f.addins);return void 0===d?c.clone(g):c.filter(g,d)}})}(b),function(a){"use strict";var b=0;a.Builder=function(d){d=c.isFunction(d)?d():d||{},d.id=d.id||"builder"+b++,d.order=d.order||0;var e=new a.Addin(d);return e.type=d.hasOwnProperty("type")?d.type:"",e},a.registry=c.assign(a.registry||{},{systemBuildersPath:"builders",addBuilder:function(b){var c=new a.Builder(b),d=this.joinPath(this.systemPathPrefix,this.systemBuildersPath);this.addAddin(d,c)},getBuilder:function(a){var b=this.joinPath(this.systemPathPrefix,this.systemBuildersPath),c=this.getAddins(b,{type:a});if(c.length>0)return c[0];if(c=this.getAddins(b,{type:null}),c.length>0)return c[0];throw new Error("No builder of type "+a+" was defined and no default builder was registered")},build:function(b,d,e){var f=a.registry.getAddins(b,d,e);return null===f?null:c.map(f,function(b){var c=a.registry.getBuilder(b);return c.build(b)})}})}(b),function(a){"use strict";a.defaultManifest={builders:[{id:"EJS.default-builder",type:null,order:0,build:function(a){return a.content}}]}}(b)});